class PurchaseController < ApplicationController

# APPLE_RECEIPT_VERIFY_URL = "https://sandbox.itunes.apple.com/verifyReceipt"
  # RECEIPT = 'ewoJInNpZ25hdHVyZSIgPSAiQWtXSDVwQnowYnh6ZkEyakVkU28zT2RheUZFd0J1eVdQVDFKTUNyVW0rYXZLcUVwSFFXRFlwc1h6SHpnRGNhQnd1M0I0dW4rdUFYQXN1RE8vb2x4VVdRRVE0K1RubjRKRSszdHFUVVRNcVc2QldNd3NYOFZ1anJrMHo3YlVCUytVaHFoTkkwSmZWUGpxNmd0ZVlQY0lCWHFnejdmc002bXhTQU9vWk03Wi84c0FBQURWekNDQTFNd2dnSTdvQU1DQVFJQ0NHVVVrVTNaV0FTMU1BMEdDU3FHU0liM0RRRUJCUVVBTUg4eEN6QUpCZ05WQkFZVEFsVlRNUk13RVFZRFZRUUtEQXBCY0hCc1pTQkpibU11TVNZd0pBWURWUVFMREIxQmNIQnNaU0JEWlhKMGFXWnBZMkYwYVc5dUlFRjFkR2h2Y21sMGVURXpNREVHQTFVRUF3d3FRWEJ3YkdVZ2FWUjFibVZ6SUZOMGIzSmxJRU5sY25ScFptbGpZWFJwYjI0Z1FYVjBhRzl5YVhSNU1CNFhEVEE1TURZeE5USXlNRFUxTmxvWERURTBNRFl4TkRJeU1EVTFObG93WkRFak1DRUdBMVVFQXd3YVVIVnlZMmhoYzJWU1pXTmxhWEIwUTJWeWRHbG1hV05oZEdVeEd6QVpCZ05WQkFzTUVrRndjR3hsSUdsVWRXNWxjeUJUZEc5eVpURVRNQkVHQTFVRUNnd0tRWEJ3YkdVZ1NXNWpMakVMTUFrR0ExVUVCaE1DVlZNd2daOHdEUVlKS29aSWh2Y05BUUVCQlFBRGdZMEFNSUdKQW9HQkFNclJqRjJjdDRJclNkaVRDaGFJMGc4cHd2L2NtSHM4cC9Sd1YvcnQvOTFYS1ZoTmw0WElCaW1LalFRTmZnSHNEczZ5anUrK0RyS0pFN3VLc3BoTWRkS1lmRkU1ckdYc0FkQkVqQndSSXhleFRldngzSExFRkdBdDFtb0t4NTA5ZGh4dGlJZERnSnYyWWFWczQ5QjB1SnZOZHk2U01xTk5MSHNETHpEUzlvWkhBZ01CQUFHamNqQndNQXdHQTFVZEV3RUIvd1FDTUFBd0h3WURWUjBqQkJnd0ZvQVVOaDNvNHAyQzBnRVl0VEpyRHRkREM1RllRem93RGdZRFZSMFBBUUgvQkFRREFnZUFNQjBHQTFVZERnUVdCQlNwZzRQeUdVakZQaEpYQ0JUTXphTittVjhrOVRBUUJnb3Foa2lHOTJOa0JnVUJCQUlGQURBTkJna3Foa2lHOXcwQkFRVUZBQU9DQVFFQUVhU2JQanRtTjRDL0lCM1FFcEszMlJ4YWNDRFhkVlhBZVZSZVM1RmFaeGMrdDg4cFFQOTNCaUF4dmRXLzNlVFNNR1k1RmJlQVlMM2V0cVA1Z204d3JGb2pYMGlreVZSU3RRKy9BUTBLRWp0cUIwN2tMczlRVWU4Y3pSOFVHZmRNMUV1bVYvVWd2RGQ0TndOWXhMUU1nNFdUUWZna1FRVnk4R1had1ZIZ2JFL1VDNlk3MDUzcEdYQms1MU5QTTN3b3hoZDNnU1JMdlhqK2xvSHNTdGNURXFlOXBCRHBtRzUrc2s0dHcrR0szR01lRU41LytlMVFUOW5wL0tsMW5qK2FCdzdDMHhzeTBiRm5hQWQxY1NTNnhkb3J5L0NVdk02Z3RLc21uT09kcVRlc2JwMGJzOHNuNldxczBDOWRnY3hSSHVPTVoydG04bnBMVW03YXJnT1N6UT09IjsKCSJwdXJjaGFzZS1pbmZvIiA9ICJld29KSW1sMFpXMHRhV1FpSUQwZ0lqTTFNVEE1TWpVek15STdDZ2tpYjNKcFoybHVZV3d0ZEhKaGJuTmhZM1JwYjI0dGFXUWlJRDBnSWpFd01EQXdNREF3TURBMk1qVTNOVE1pT3dvSkluQjFjbU5vWVhObExXUmhkR1VpSUQwZ0lqSXdNVEF0TURjdE1qQWdNRGc2TWpFNk5UTWdSWFJqTDBkTlZDSTdDZ2tpY0hKdlpIVmpkQzFwWkNJZ1BTQWlhbkF1YTNKaGVTNWpZWEJ3Y3k1dGIyTnJMbWxzYkhWemRDNHhJanNLQ1NKMGNtRnVjMkZqZEdsdmJpMXBaQ0lnUFNBaU1UQXdNREF3TURBd01EWXlOVGMxTXlJN0Nna2ljWFZoYm5ScGRIa2lJRDBnSWpFaU93b0pJbTl5YVdkcGJtRnNMWEIxY21Ob1lYTmxMV1JoZEdVaUlEMGdJakl3TVRBdE1EY3RNakFnTURnNk1qRTZOVE1nUlhSakwwZE5WQ0k3Q2draVltbGtJaUE5SUNKcWNDNXJjbUY1TG1OaGNIQnpJanNLQ1NKaWRuSnpJaUE5SUNJeExqQWlPd3A5IjsKCSJwb2QiID0gIjEwMCI7Cgkic2lnbmluZy1zdGF0dXMiID0gIjAiOwp9'
  # RECEIPT = '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'
  protect_from_forgery :except => [:add_point, :subscribe]
  before_action :set_current_member, only: [:add_point, :subscribe]

  expose(:member) { @current_member }
  # def add_point

  #   begin
  #   receipt_data = RECEIPT #subscribe_params[:receipt_data]
  #   # receipt_data = purchase_params[:receipt_data]
  #   member_id = purchase_params[:member_id]
  #   @add_point_count = 0

  #   # params_json = "{ \"receipt-data\": \"#{open("./receipt").read}\"  }"
 
  #   # Use net/http to post to apple sandbox server
  #   # uri = URI("https://sandbox.itunes.apple.com") # Use "https://buy.itunes.apple.com" for production
  #   # Net::HTTP.start(uri.host, uri.port, :use_ssl => uri.scheme == 'https') do |http|
  #   #   response = http.post('/verifyReceipt', RECEIPT)
  #   #   # Puts the result! (see an example below - result.json)
  #   #   puts response.body
  #   # end

  #   # puts "raw receipt data => #{receipt_data}"
  #   # Itunes.sandbox!
  #   # Itunes.sandbox = false

  #   receipt = Itunes::Receipt.verify! receipt_data, :allow_sandbox 
    
  #   # puts "receipt => #{receipt.as_json}"
  #   # puts "receipt kind_of => #{receipt.kind_of?(Array)}"
  #   # puts "receipt env=> #{receipt.itunes_env}"

  #   # receipt.in_app.each do |rec|
  #   #   @purchase = HistoryPurchase.check_purchase(@current_member, rec)

  #   #   if @purchase
  #   #     @add_point_count = @add_point_count + 1
  #   #   end
  #   # end

  #   # puts "add point count => #{@add_point_count}"
  #     render :json => {:response_status => "OK", :receipt => receipt}
  #   rescue => e
  #     render :json => {:response_status => "ERROR", :response_message => e.message }, :status => 400
  #   end

  # end

  def add_point
    HistoryPurchase.transaction do
      begin
      @add_point_count = 0
      receipt_data = params[:receipt]

      # puts "receipt_data => #{receipt_data}"
      receipt_data["in_app"].each do |rec|
        @purchase = HistoryPurchase.check_purchase(@current_member, rec)

        if @purchase
          @add_point_count = @add_point_count + 1
        end
      end
      rescue => e
        render :json => {:response_status => "ERROR", :response_message => e.message }, :status => 400
      end
    end
  end

  def subscribe
    puts "subscribe"
    begin
    # receipt_data = RECEIPT #subscribe_params[:receipt_data]
    receipt_data = purchase_params[:receipt_data]
    puts "raw receipt data => #{receipt_data}"

    receipt = Itunes::Receipt.verify! receipt_data, :allow_sandbox  

    puts "receipt => #{receipt}"
    puts "receipt => #{receipt.as_json}"
    puts "receipt => #{receipt.kind_of?(Array)}"

    if receipt.kind_of?(Array)
      receipt.in_app.each do |rec|
        HistoryPurchase.check_subscribe(@current_member, rec)
      end
    else
      HistoryPurchase.check_subscribe(@current_member, receipt)
    end

    rescue => e
      render :json => {:response_status => "ERROR", :response_message => e.message }, :status => 400
    end
  end

  private


  def purchase_params
    params.permit(:member_id, :receipt_data)
  end


end